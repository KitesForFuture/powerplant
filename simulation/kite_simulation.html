<html><head>
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<meta charset="utf-8">
		<meta name="viewport" >
		<link rel="stylesheet" href="mystyle.css">
	</head>
	<body>
		
		<table style="width:100%">
			<tr style="vertical-align: top;">
				<td>
					<table style="width:100%;font-size: 10px">
						
						<tr><td>
							<a href="https://www.kitesforfuture.de" target="_top" class="class1" style="background-color: black;">&#8678; Kites for Future</a>
						</tr>
						
						<tr><td>
							<button type="button" id="startPauseSimulation" onclick="startPauseSimulation()" style="color: green;">start/pause</button></td>
						</tr>
						<tr><td>
							<button type="button" id="land" onclick="land()" style="color: black;">LAND</button></td>
						</tr>
						<tr><td>
							<button type="button" id="launch" onclick="launch()" style="color: black;">LAUNCH</button></td>
						</tr>
						<tr><td>
							Zoom: 
							<button type="button" id="zoomIn" onclick="zoomIn()" style="color: black;">+</button>
							<button type="button" id="zoomOut" onclick="zoomOut()" style="color: black;">-</button></td>
						</tr>
						<tr><td>
							<button type="button" id="moveCamera" onclick="moveCamera()" style="color: green;">move camera</button></td>
						</tr>
						<tr><td>
							<button type="button" id="elevonControlOff" onclick="elevonControlOff_func()" style="color: green;">Control OFF</button></td>
						</tr>
						<tr>
						<td>
						<p id="UI"></p>
						</td>
						</tr>
						
					</table>
				</td>
				<td style = "position: relative;">
					<canvas id="canvas_for_visualization" width = "800" height= "600" style="overflow: scroll;width:100%;"> </canvas>
					<div style="position: absolute; left: 0pt; bottom: 0pt; opacity: 0.5;"><canvas id="canvas_for_wind_diagram" width = "400" height= "200" style="overflow: scroll;width:100%;"> </canvas></div>
				</td>
				<td>
				 	<table style="width:100%">
					  <tr>
						<td style = "position: relative;">
							<canvas id="canvas_for_coefficients" width = "400" height= "200" style="overflow: scroll;width:100%;"> </canvas>
							<div style="position: absolute; left: 3pt; top: 0;">C<sub>L</sub>, C<sub>D</sub> = 2</div>
							<div style="position: absolute; left: 3pt; bottom: 0;">C<sub>L</sub>, C<sub>D</sub> = -2</div>
							<div style="position: absolute; left: 3pt; bottom: 50%;">AoA = 0</div>
							<div style="position: absolute; right: 3pt; bottom: 50%;">AoA = &#960;</div>
						</td>
					  </tr>
					  <tr>
						<td style = "position: relative;">
							<canvas id="canvas_for_l_d" width = "400" height= "200" style="overflow: scroll;width:100%;"> </canvas>
							<div style="position: absolute; left: 3pt; top: 0;">C<sub>L</sub> = 2</div>
							<div style="position: absolute; left: 3pt; bottom: 0;">C<sub>L</sub> = -2</div>
							<div style="position: absolute; left: 3pt; bottom: 50%;">C<sub>D</sub> = 0</div>
							<div style="position: absolute; right: 3pt; bottom: 50%;">C<sub>D</sub> = 0.5</div>
						</td>
					  </tr>
					  <tr>
						<td style = "position: relative;">
							<canvas id="canvas_for_data" width = "400" height= "200" style="overflow: scroll;width:100%;"> </canvas>
							<div style="position: absolute; left: 3pt; bottom: 0pt;color: red;"><p id="power_in_graph"></p></div>
							<div style="position: absolute; right: 3pt; bottom: 0;color: black;"><p id="energy_in_graph"></p></div>
						</td>
					  </tr>
					</table> 
				</td>
			</tr>
		</table>
		
		<script src="three.min.js"></script>
		<script src="three_additional_math.js"></script>
		<script src="Timer.js"></script>
		<script src="AsyncTimer.js"></script>
		<script src="math.js"></script>
		<script src="Smoke.js"></script>
		<script src="Visualization.js"></script>
		<script src="ForceData.js"></script>
		<script src="KitePart.js"></script>
		<script src="FlatPlate.js"></script>
		<script src="Propeller.js"></script>
		<script src="KiteVisualization.js"></script>
		<script src="AirfoilCoefficientsVisualization.js"></script>
		<script src="DataPlot.js"></script>
		<script src="WindDiagram.js"></script>
		<script src="Wind.js"></script>
		<script src="RigidBody.js"></script>
		<script src="VectorVis.js"></script>
		<script src="CGIndicator.js"></script>
		<script src="Kite.js"></script>
		<script src="SensorData.js"></script>
		<script src="ControlData.js"></script>
		<script src="Autopilot.js"></script>
		<script src="Actuator.js"></script>
		<script src="SlowlyChangingAngle.js"></script>
		<script src="Groundstation.js"></script>
		<script src="Servo.js"></script>
		<script src="BLDCMotor.js"></script>
		<script src="UIElement.js"></script>
		<script src="SlidableVariable.js"></script>
		<script src="Collapsible.js"></script>
		
		<script>
		
			"use strict";
			
			var width, height, dpr;
			
			var running = true;
			var camAttachedToKite = true;
			var elevonControlOff = false;
			
			// SIMULATION and VISUALIZATION of the KITE
			var wind;
			var kite;
			var rudderServo;
			var leftElevonServo;
			var rightElevonServo;
			var leftBLDC;
			var rightBLDC;
			var autopilot;
			var groundstation;
			var smoothLineTension;
			var visualization;
			var airfoilVisualization;
			var airfoilVisualization2;
			var dataPlot;
			var windDiagram;
			var energy = 0;
			var time = 0;
			var timestep_multiplier = 100;
			
			var testBall = new THREE.Mesh(new THREE.SphereBufferGeometry(0.05, ), new THREE.MeshBasicMaterial( { color: new THREE.Color('red') } ) );
			
			var old_kite_line_length = 0;
			
			// UI
			
			var kiteDimensionsCollapsible;
			var autopilotSettingsCollapsible;
			var environmentCollapsible;
			var measurementsCollapsible;
			var simulationSettingsCollapsible;
			
			var timeUIElement;
			var rope_lengthUIElement;
			var rope_angle_horizonUIElement;
			var flying_heightUIElement;
			var speedUIElement;
			var glide_ratioUIElement;
			var powerUIElement;
			var energyUIElement;
			var electricity_costUIElement;
			var line_tensionSlider;
			
			init();
			
			function init() {
				
				// ORGANIZING PAGE LAYOUT
				let collapsibles = [];
				
				// KITE DIMENSIONS
				
				kiteDimensionsCollapsible = new Collapsible("kite_dimensions", "Kite Dimensions");
				collapsibles.push(kiteDimensionsCollapsible);
				
				let wingspanSlider = kiteDimensionsCollapsible.add( new SlidableVariable("wingspan", "Wingspan", 1, 100, 20, 10, 0, " cm") );
				wingspanSlider.oninput = function(that){ kite.dimensions.y = that.value*0.1; kite.updateDimensionsAndPositionsOfParts(); massUIElement.setString("mass: " + kite.mass.toFixed(3) + " kg");};
				let prop_distSlider = kiteDimensionsCollapsible.add( new SlidableVariable("prop_dist", "Dist Prop from Center", 0, 100, 75, 1, 0, "%") );
				let elevon_spanSlider = kiteDimensionsCollapsible.add( new SlidableVariable("elevon_span", "Elevon length", 1, 50, 5, 10, 0, " cm") );
				elevon_spanSlider.oninput = function(that){ kite.elevonData.dimensions.y = that.value*0.1; kite.updateDimensionsAndPositionsOfParts(); };
				let stabilizer_distanceSlider = kiteDimensionsCollapsible.add( new SlidableVariable("stabilizer_distance", "Stabilizer Distance", 0, 200, 15, 1, 0, " cm") );
				stabilizer_distanceSlider.oninput = function(that){ kite.rudderData.distanceFromCG = that.value*0.01; kite.updateDimensionsAndPositionsOfParts(); };
				let stabilizer_depthSlider = kiteDimensionsCollapsible.add( new SlidableVariable("stabilizer_depth", "Stabilizer Depth", 0, 100, 25, 1, 0, " cm") );
				stabilizer_depthSlider.oninput = function(that){ kite.rudderData.StabilizerDimensions.x = that.value*0.01; kite.updateDimensionsAndPositionsOfParts(); };
				
				let tannenbaum_lengthSlider = kiteDimensionsCollapsible.add( new SlidableVariable("tannenbaum_length", "Line Attachment Length", 0, 50, 5, 1, 0, " cm") );
				let bridle_lengthSlider = kiteDimensionsCollapsible.add( new SlidableVariable("bridle_length", "Bridle Length", 0, 100, 20, 1, 0, " cm") );
				
				tannenbaum_lengthSlider.oninput = function(that){ kite.setTannenbaumLengthAndBridleLength(that.value*0.01, bridle_lengthSlider.getSliderElement().value*0.01); };
				bridle_lengthSlider.oninput = function(that){console.log("test");kite.setTannenbaumLengthAndBridleLength(tannenbaum_lengthSlider.getSliderElement().value*0.01, that.value*0.01); };
				prop_distSlider.oninput = function(that){ kite.setPropellerDistance(that.value * 0.01); };
				
				let massUIElement = kiteDimensionsCollapsible.add( new UIElement("mass") );
				
				// AUTOPILOT SETTINGS
				
				autopilotSettingsCollapsible = new Collapsible("autopilot_settings", "Autopilot Settings");
				collapsibles.push(autopilotSettingsCollapsible);
				
				let reflexSlider = autopilotSettingsCollapsible.add( new SlidableVariable("reflex", "Reflex", 0, 45, 15, 1, 0, "째") );
				let qr_neutralSlider = autopilotSettingsCollapsible.add( new SlidableVariable("qr_neutral", "QR Neutral Pos", -25, 25, 15, 1, 0, "째") );
				let y_pSlider = autopilotSettingsCollapsible.add( new SlidableVariable("y_p", "y_p", -10, 10, 0, 1, 0, "") );
				
				
				reflexSlider.oninput = function(that){ kite.setReflex(parseFloat(that.value) * Math.PI / 180); };
				qr_neutralSlider.oninput = function(that){ autopilot.qr_neutral = that.value; };
				y_pSlider.oninput = function(that){ autopilot.hover.Y.P = 1.5**that.value; };
				
				let reelout_tensionSlider = autopilotSettingsCollapsible.add( new SlidableVariable("reelout_tension", "Reelout tension", 0, 1000, 100, 1, 0, " N") );
				reelout_tensionSlider.oninput = function(that){ groundstation.max8Tension = that.value; groundstation.min8Tension = that.value; groundstation.maxLandingTension = that.value;};
				
				// ENVIRONMENT
				
				environmentCollapsible = new Collapsible("environment", "Environment Settings");
				collapsibles.push(environmentCollapsible);
				
				let wind_speedSlider = environmentCollapsible.add( new SlidableVariable("wind_speed", "Wind speed", 0, 50, 25, 0.5, 1, " m/s") );
				let wind_directionSlider = environmentCollapsible.add( new SlidableVariable("wind_direction", "Wind direction", -200, 200, 0, 1, 0, "째") );
				
				wind_speedSlider.oninput = function(that){ wind.setSpeedAndDirection(that.value*0.5, wind_directionSlider.getSliderElement().value); };
				wind_directionSlider.oninput = function(that){ wind.setSpeedAndDirection(wind_speedSlider.getSliderElement().value*0.5, that.value); };
				
				// MEASUREMENTS
				
				measurementsCollapsible = new Collapsible("measurements", "Measurements");
				collapsibles.push(measurementsCollapsible);
				
				timeUIElement = measurementsCollapsible.add( new UIElement("time") );
				rope_lengthUIElement = measurementsCollapsible.add( new UIElement("rope_length") );
				rope_angle_horizonUIElement = measurementsCollapsible.add( new UIElement("rope_angle_horizon") );
				flying_heightUIElement = measurementsCollapsible.add( new UIElement("flying_height") );
				speedUIElement = measurementsCollapsible.add( new UIElement("speed") );
				glide_ratioUIElement = measurementsCollapsible.add( new UIElement("glide_ratio") );
				powerUIElement = measurementsCollapsible.add( new UIElement("power") );
				energyUIElement = measurementsCollapsible.add( new UIElement("energy") );
				electricity_costUIElement = measurementsCollapsible.add( new UIElement("electricity_cost") );
				line_tensionSlider = measurementsCollapsible.add( new SlidableVariable("line_tension", "Line tension", 0, 1000, 1, 1, 0, " N") );
				
				
				// SIMULATION SETTINGS
				simulationSettingsCollapsible = new Collapsible("simSettings", "Simulation Settings");
				collapsibles.push(simulationSettingsCollapsible);
				
				let zeitschrittUIElement = simulationSettingsCollapsible.add( new UIElement("zeitschritt") );
				let timestep_multiplier_exponentSlider = simulationSettingsCollapsible.add( new SlidableVariable("timestep_multiplier_exponent", "TimeStepExp", 0, 4, 2, 1, 0, "") );
				timestep_multiplier_exponentSlider.oninput = function(that){ timestep_multiplier = 10**that.value; zeitschrittUIElement.setString("Timestep: 1/" + timestep_multiplier); }
				
				
				// ASSEMBLING AND SETTING PAGE LAYOUT
				
				document.getElementById("UI").innerHTML += collapsibles[0].getHTML();
				for(let i = 1; i < collapsibles.length; i++){
					document.getElementById("UI").innerHTML += "<br>";
					document.getElementById("UI").innerHTML += collapsibles[i].getHTML();
				}
				
				for(let i = 0; i < collapsibles.length; i++){
					collapsibles[i].init();
				}
				
				wind = new Wind();
				
				kite = new Kite();
				kite.angular_velocity.set(0, 0, 0);//0.1, 0.1, 0.1);
				
				rudderServo = new Servo(); leftElevonServo = new Servo(); rightElevonServo = new Servo(); leftBLDC = new BLDCMotor(); rightBLDC = new BLDCMotor();
				
				autopilot = new Autopilot();
				
				let c_l_by_c_d = 5;
				// min8T, max8T, minLT, maxLT, minLS, maxLS
				groundstation = new Groundstation(100, 100/*30, 1000*/, 2, 100, 2, 3, c_l_by_c_d, kite.dimensions.x * kite.dimensions.y);
				smoothLineTension = new Actuator(500, 0, 1000);
				
				visualization = new KiteVisualization("canvas_for_visualization", kite, wind);
				
				airfoilVisualization = new AirfoilCoefficientsVisualization("canvas_for_coefficients", kite.simpleWing1, kite.simpleWing2, "L,D");
				airfoilVisualization2 = new AirfoilCoefficientsVisualization("canvas_for_l_d", kite.simpleWing1, kite.simpleWing2, "L/D");
				dataPlot = new DataPlot("canvas_for_data");
				windDiagram = new WindDiagram("canvas_for_wind_diagram");
				
				
				animate();
			}
			
			function animate() {
				
				var timestep_in_ms = 1000/50; // 50Hz
				var timestep_in_s = 0.001*timestep_in_ms;
				
				if(running){
					
					// AUTOPILOT
					//autopilot.hover.Y.P = 1.5**y_p.value;
					
					wind.update();
					let lineDir = kite.positionR.clone();
					let kiteVelocity = kite.velocity.clone();
					let reelOutVector = projectToNormedVector(kiteVelocity, lineDir.normalize());
					windDiagram.setWindVector(wind.speed, wind.speed - Math.sqrt(reelOutVector.z*reelOutVector.z + reelOutVector.y*reelOutVector.y), reelOutVector.x);
					//console.log("" + wind.speed + ", " + Math.sqrt(kite.velocity.z*kite.velocity.z + kite.velocity.y*kite.velocity.y) + ", " + kite.velocity.x);
					
					var controlData = autopilot.step(kite.getSensorData(), kite.positionR.length(), line_tensionSlider.getSliderElement().value, timestep_in_s);
					
					// UI and LINE TENSION
					line_tensionSlider.setSlider(controlData.line_tension);
					smoothLineTension.step(timestep_in_s);
					smoothLineTension.setTargetValue(line_tensionSlider.getSliderElement().value);
					
					let kite_line_length = kite.positionR.length();
					time += timestep_in_s;
					timeUIElement.setString("Time: " + time.toFixed(0) + " s (" + (time/3600).toFixed(3) + " h)");
					rope_lengthUIElement.setString("Line length: " + kite_line_length.toFixed(0) + " m");
					rope_angle_horizonUIElement.setString("Line angle to horizon: " + (180/Math.PI*Math.asin(projectToNormedVector(kite.positionR.clone().normalize(), new THREE.Vector3(1, 0, 0)).length())).toFixed(0) + "째");
					flying_heightUIElement.setString("Height: " + kite.positionR.x.toFixed(0) + " m");
					speedUIElement.setString("Speed: " + kite.velocity.length().toFixed(0) + " m/s");
					let AoA = kite.simpleWing1.AoA_for_vis;
					let C_L = lift_coefficient(AoA, kite.simpleWing1);
					let C_D = drag_coefficient(AoA, 2*kite.simpleWing1.dimensions.y/kite.simpleWing1.dimensions.x, kite.simpleWing1);
					glide_ratioUIElement.setString("L/D: " + (C_L/C_D).toFixed(1));
					if(old_kite_line_length != 0){
						let kite_line_length_difference = kite_line_length - old_kite_line_length;
						if(line_tensionSlider.getSliderElement().value != 1){
							//groundstation.factor = autopilot.hover.Y.P;
							smoothLineTension.setTargetValue( groundstation.getLineTension(kite_line_length_difference/timestep_in_s) );
							line_tensionSlider.setSlider(smoothLineTension.getValue());
						}
						let power = kite_line_length_difference*line_tensionSlider.getSliderElement().value/timestep_in_s;
						energy += power * timestep_in_s;
						powerUIElement.setString("Power: " + power.toFixed(0) + " W (" + (energy/time).toFixed(0) + " W avg)"); dataPlot.addPoint(2, time, power); document.getElementById("power_in_graph").innerHTML = "Power:<br>"+power.toFixed(0)+" W";
						energyUIElement.setString("Energy: " + energy.toFixed(0) + " Ws" + " (" + (energy/3600000).toFixed(6) + " kWh)"); dataPlot.addPoint(0, time, energy); document.getElementById("energy_in_graph").innerHTML = "Energy:<br>" + energy.toFixed(0) + " Ws" + " (" + (energy/3600000).toFixed(6) + " kWh)";
						electricity_costUIElement.setString("Electricity Cost: " + (850/(energy/time)).toFixed(1) + " ct/kWh)");
						
					}
					old_kite_line_length = kite_line_length;
					
					
					// PHYSICS
					
					let timestep_fraction_in_s = timestep_in_s / timestep_multiplier;
					for (let i = 0; i < timestep_multiplier; i++){
					
						leftElevonServo.setTargetValue(controlData.left_elevon * Math.PI/180); leftElevonServo.step(timestep_fraction_in_s);
						rightElevonServo.setTargetValue(controlData.right_elevon * Math.PI/180); rightElevonServo.step(timestep_fraction_in_s);
						rudderServo.setTargetValue(controlData.rudder * Math.PI/180); rudderServo.step(timestep_fraction_in_s);
						leftBLDC.setTargetValue(controlData.left_prop); leftBLDC.step(timestep_fraction_in_s);
						rightBLDC.setTargetValue(controlData.right_prop); rightBLDC.step(timestep_fraction_in_s);
						
						kite.leftPropeller.setThrust(leftBLDC.getValue());
						kite.rightPropeller.setThrust(rightBLDC.getValue());
						if(!elevonControlOff){
							kite.leftElevon.rotation.y = leftElevonServo.getValue();
							kite.rightElevon.rotation.y = rightElevonServo.getValue();
						}
						kite.rudder.rotation.y = rudderServo.getValue();
						
						kite.update(wind, line_tensionSlider.getSliderElement().value, timestep_fraction_in_s);
						kite.leftPropeller.update();
						kite.rightPropeller.update();
					}
				}
				
				visualization.update(timestep_in_s*running);
				
				render();
				
				setTimeout(function(){
				    requestAnimationFrame( animate )
				}, timestep_in_ms);
			}
			
			function render(){
				visualization.render();
			}
			
			function startPauseSimulation(){
				running = !running;
				if(running)
					document.getElementById("startPauseSimulation").style.color = "green";
				else
					document.getElementById("startPauseSimulation").style.color = "red";
			}
			
			function zoomIn(){
				visualization.camera.zoom *= 1.5;
				visualization.camera.updateProjectionMatrix();
			}
			
			function zoomOut(){
				visualization.camera.zoom *= 0.66;
				visualization.camera.updateProjectionMatrix();
			}
			
			function moveCamera(){
				
				if(camAttachedToKite){
					visualization.cameraAttachedToKite = false;
				}else{
					visualization.cameraAttachedToKite = true;
				}
				camAttachedToKite = !camAttachedToKite;
			}
			
			function land(){
				autopilot.mode = FINAL_LANDING_MODE;
			}
			
			function launch(){
				autopilot.mode = HOVER_MODE;
			}
			
			function elevonControlOff_func(){
				if(elevonControlOff){
					
					document.getElementById("elevonControlOff").style.color = "green";
					elevonControlOff = false;
				}else{
					
					document.getElementById("elevonControlOff").style.color = "red";
					elevonControlOff = true;
				}
			}

		</script>

	</body>
</html>
