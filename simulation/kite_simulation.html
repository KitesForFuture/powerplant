<html><head>
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<meta charset="utf-8">
		<meta name="viewport" >
		<style>
			
			buttonInactive{
			  background-color: gray;
			  color: white;
			  padding: 5px 1px;
			  text-align: center;
			  text-decoration: none;
			  display: inline-block;
			}
			
			a.class1:link, a.class1:visited {
			  background-color: #4fa48a;
			  color: white;
			  text-align: center;
			  text-decoration: none;
			}
			
			a.class1:hover, a.class1:active {
			  background-color: #36705f;
			}
			
			a.class1 {
			  margin-top: 0vw;
			  margin-bottom: 1vw;
			  margin-right: 0vw;
			  margin-left: 0vw;
			  border-radius: 0vw;
						  
			  width: 100%;
  			  padding: 5px 1px;
			  display: inline-block;
			  border: none;
			  box-shadow: none;
			  box-sizing: border-box;
			  cursor: pointer;
			  font-size: 1.5vmin;
			  font-weight: 600;
			  box-shadow: none;
			}
			
			.collapsible {
			  background-color: #777;
			  color: white;
			  cursor: pointer;
			  outline: none;
			}

			.active, .collapsible:hover {
			  background-color: #555;
			}

			
		</style>
	</head>
	<body>
		
		<table style="width:100%">
			<tr style="vertical-align: top;">
				<td>
					<table style="width:100%;font-size: 10px">
						
						<tr><td>
							<a href="https://www.kitesforfuture.de" target="_top" class="class1" style="background-color: black;">&#8678; Kites for Future</a>
						</tr>
						
						<tr><td>
							<button type="button" id="startPauseSimulation" onclick="startPauseSimulation()" style="color: green;">start/pause</button></td>
						</tr>
						<tr><td>
							<button type="button" id="land" onclick="land()" style="color: black;">LAND</button></td>
						</tr>
						<tr><td>
							<button type="button" id="launch" onclick="launch()" style="color: black;">LAUNCH</button></td>
						</tr>
						<tr><td>
							Zoom: 
							<button type="button" id="zoomIn" onclick="zoomIn()" style="color: black;">+</button>
							<button type="button" id="zoomOut" onclick="zoomOut()" style="color: black;">-</button></td>
						</tr>
						<tr>
						<td>
						<p id="UI"></p>
						</td>
						</tr>
						
						
						<tr>
						<td>
						<button type="button" class="collapsible">Environment</button>
						<div style="font-size: 10px;display:none;">
						  	<table style="font-size: 10px;">
						  		
						  		<tr>
									<td>
										<p id="wind_speed_p">Wind speed:</p>
									</td>
								</tr>
								<tr>
									<td>
										<input type="range" id="wind_speed" min="0" max="50" style="height: 5px;">
									</td>
								</tr>
								<tr>
								<tr>
									<td>
										Wind direction
									</td>
								</tr>
									<td>
										<input type="range" value="0" id="wind_direction" min="-200" max="200" style="height: 5px;">
									</td>
								</tr>
						  		
						  	</table>
						  	<hr>
						</div>
						</td>
						</tr>
						
						<tr>
						<td>
						<button type="button" class="collapsible">Measurements</button>
						<div style="font-size: 10px;display:none;">
						  	<table style="font-size: 10px;">
						  		
						  		<tr>
									<td>
										<p id="time">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="rope_length">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="rope_angle_horizon">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="flying_height">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="speed">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="glide_ratio">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="power">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="energy">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="electricity_cost">0</p>
									</td>
								</tr>
								
								<tr>
									<td>
										<p id="line_tension_p">Line tension:</p>
									</td>
								</tr>
								<tr>
									<td>
										<input type="range" id="line_tension" min="0" max="1000" style="height: 5px;">
									</td>
								</tr>
						  		
						  	</table>
						  	<hr>
						</div>
						</td>
						</tr>
						
						<tr>
						<td>
						<button type="button" class="collapsible">Simulation Settings</button>
						<div style="font-size: 10px; display:none;">
						  	<table style="font-size: 10px;">
						  		
								<tr><td>
									<button type="button" id="moveCamera" onclick="moveCamera()" style="color: green;">move camera</button></td>
								</tr>
								<tr><td>
									<button type="button" id="elevonControlOff" onclick="elevonControlOff_func()" style="color: green;">Control OFF</button></td>
								</tr>
						  		<tr>
									<td>
										time step = <p id="zeitschritt">1/100</p>
									</td>
								</tr>
								<tr>
									<td>
										<input type="range" id="timestep_multiplier_exponent" min="0" max="4" style="height: 5px;">
									</td>
								</tr>
								
								
								<tr>
									<td>
										Autopilot-Log = <p id="autopilot_logging"></p>
									</td>
								</tr>
						  		
						  	</table>
						  	<hr>
						</div>
						</td>
						</tr>
						
					</table>
				</td>
				<td>
					<canvas id="canvas_for_visualization" width = "800" height= "600" style="overflow: scroll;width:100%;"> </canvas>
				</td>
				<td>
				 	<table style="width:100%">
					  <tr>
						<td style = "position: relative;">
							<canvas id="canvas_for_coefficients" width = "400" height= "300" style="overflow: scroll;width:100%;"> </canvas>
							<div style="position: absolute; left: 3pt; top: 0;">C<sub>L</sub>, C<sub>D</sub> = 2</div>
							<div style="position: absolute; left: 3pt; bottom: 0;">C<sub>L</sub>, C<sub>D</sub> = -2</div>
							<div style="position: absolute; left: 3pt; bottom: 50%;">AoA = 0</div>
							<div style="position: absolute; right: 3pt; bottom: 50%;">AoA = &#960;</div>
						</td>
					  </tr>
					  <tr>
						<td style = "position: relative;">
							<canvas id="canvas_for_l_d" width = "400" height= "300" style="overflow: scroll;width:100%;"> </canvas>
							<div style="position: absolute; left: 3pt; top: 0;">C<sub>L</sub> = 2</div>
							<div style="position: absolute; left: 3pt; bottom: 0;">C<sub>L</sub> = -2</div>
							<div style="position: absolute; left: 3pt; bottom: 50%;">C<sub>D</sub> = 0</div>
							<div style="position: absolute; right: 3pt; bottom: 50%;">C<sub>D</sub> = 0.5</div>
						</td>
					  </tr>
					</table> 
				</td>
			</tr>
		</table>
		
		<script src="three.min.js"></script>
		<script src="three_additional_math.js"></script>
		<script src="Timer.js"></script>
		<script src="AsyncTimer.js"></script>
		<script src="math.js"></script>
		<script src="Smoke.js"></script>
		<script src="Visualization.js"></script>
		<script src="ForceData.js"></script>
		<script src="KitePart.js"></script>
		<script src="FlatPlate.js"></script>
		<script src="Propeller.js"></script>
		<script src="KiteVisualization.js"></script>
		<script src="AirfoilCoefficientsVisualization.js"></script>
		<script src="Wind.js"></script>
		<script src="RigidBody.js"></script>
		<script src="VectorVis.js"></script>
		<script src="Kite.js"></script>
		<script src="SensorData.js"></script>
		<script src="ControlData.js"></script>
		<script src="Autopilot.js"></script>
		<script src="Actuator.js"></script>
		<script src="SlowlyChangingAngle.js"></script>
		<script src="Groundstation.js"></script>
		<script src="Servo.js"></script>
		<script src="BLDCMotor.js"></script>
		<script src="UIElement.js"></script>
		<script src="SlidableVariable.js"></script>
		<script src="Collapsible.js"></script>
		
		<script>
		
			"use strict";
			
			var width, height, dpr;
			
			var running = true;
			var camAttachedToKite = true;
			var elevonControlOff = false;
			
			// SIMULATION and VISUALIZATION of the KITE
			var wind;
			var kite;
			var rudderServo;
			var leftElevonServo;
			var rightElevonServo;
			var leftBLDC;
			var rightBLDC;
			var autopilot;
			var groundstation;
			var smoothLineTension;
			var visualization;
			var airfoilVisualization;
			var airfoilVisualization2;
			var energy = 0;
			var time = 0;
			var timestep_multiplier = 100;
			
			var testBall = new THREE.Mesh(new THREE.SphereBufferGeometry(0.05, ), new THREE.MeshBasicMaterial( { color: new THREE.Color('red') } ) );
			
			var old_kite_line_length = 0;
			
			var kiteDimensionsCollapsible;
			var autopilotSettingsCollapsible;
			
			init();
			
			function init() {
				
				// ORGANIZING PAGE LAYOUT
				let collapsibles = [];
				
				// KITE DIMENSIONS
				
				kiteDimensionsCollapsible = new Collapsible("kite_dimensions", "Kite Dimensions");
				collapsibles.push(kiteDimensionsCollapsible);
				
				let tannenbaum_lengthSlider = kiteDimensionsCollapsible.add( new SlidableVariable("tannenbaum_length", "Line Attachment Length", 0, 50, 5, 1, 0, " cm") );
				let bridle_lengthSlider = kiteDimensionsCollapsible.add( new SlidableVariable("bridle_length", "Bridle Length", -50, 50, 20, 1, 0, " cm") );
				let prop_distSlider = kiteDimensionsCollapsible.add( new SlidableVariable("prop_dist", "Dist Prop from Center", 0, 100, 75, 1, 0, "%") );
				
				tannenbaum_lengthSlider.oninput = function(that){ kite.setTannenbaumLengthAndBridleLength(that.value*0.01, bridle_lengthSlider.getSliderElement().value*0.01); };
				bridle_lengthSlider.oninput = function(that){console.log("test");kite.setTannenbaumLengthAndBridleLength(tannenbaum_lengthSlider.getSliderElement().value*0.01, that.value*0.01); };
				prop_distSlider.oninput = function(that){ kite.setPropellerDistance(that.value * 0.01); };
				
				// AUTOPILOT SETTINGS
				
				autopilotSettingsCollapsible = new Collapsible("autopilot_settings", "Autopilot Settings");
				collapsibles.push(autopilotSettingsCollapsible);
				
				let reflexSlider = autopilotSettingsCollapsible.add( new SlidableVariable("reflex", "Reflex", 0, 45, 15, 1, 0, "°") );
				let qr_neutralSlider = autopilotSettingsCollapsible.add( new SlidableVariable("qr_neutral", "QR Neutral Pos", -25, 25, 15, 1, 0, "°") );
				let y_pSlider = autopilotSettingsCollapsible.add( new SlidableVariable("y_p", "y_p", -10, 10, 0, 1, 0, "") );
				
				
				reflexSlider.oninput = function(that){ kite.setReflex(parseFloat(that.value) * Math.PI / 180); };
				qr_neutralSlider.oninput = function(that){ autopilot.qr_neutral = that.value; };
				y_pSlider.oninput = function(that){ autopilot.hover.Y.P = 1.5**that.value; };
				
				
				
				
				// ENVIRONMENT
				
				// MEASUREMENTS
				
				// SIMULATION SETTINGS
				
				
				// ASSEMBLING AND SETTING PAGE LAYOUT
				
				document.getElementById("UI").innerHTML += collapsibles[0].getHTML();
				for(let i = 1; i < collapsibles.length; i++){
					document.getElementById("UI").innerHTML += "<br>";
					document.getElementById("UI").innerHTML += collapsibles[i].getHTML();
				}
				
				for(let i = 0; i < collapsibles.length; i++){
					collapsibles[i].init();
				}
				
				
				var wind_speed = document.getElementById("wind_speed");					wind_speed.value = 25;
				var wind_direction = document.getElementById("wind_direction");			wind_direction.value = 0;
				var line_tension = document.getElementById("line_tension");				line_tension.value = 1;
				//var y_angle_offset = document.getElementById("y_angle_offset");			y_angle_offset.value = 15;
				//var reflex = document.getElementById("reflex");							reflex.value = 15;
				//var qr_neutral = document.getElementById("qr_neutral");					qr_neutral.value = 15;
				
				var timestep_multiplier_exponent = document.getElementById("timestep_multiplier_exponent");
																						timestep_multiplier_exponent.value = 2;
																						
				//var y_p = document.getElementById("y_p");	y_p.value = 0;
				
				
				
				timestep_multiplier_exponent.oninput = function(){
					timestep_multiplier = 10**this.value;
					document.getElementById("zeitschritt").innerHTML = "1/" + timestep_multiplier;
				}
				
				wind = new Wind();
				
				kite = new Kite();
				kite.angular_velocity.set(0, 0, 0);//0.1, 0.1, 0.1);
				
				rudderServo = new Servo(); leftElevonServo = new Servo(); rightElevonServo = new Servo(); leftBLDC = new BLDCMotor(); rightBLDC = new BLDCMotor();
				
				autopilot = new Autopilot();
				
				let c_l_by_c_d = 5;
				// min8T, max8T, minLT, maxLT, minLS, maxLS
				groundstation = new Groundstation(100, 100/*30, 1000*/, 2, 30, 2, 3, c_l_by_c_d, kite.dimensions.x * kite.dimensions.y);
				smoothLineTension = new Actuator(500, 0, 1000); //TODO: 250 as first argument (speed) keeps vibrations short when transitioning to landing mode, maybe better to communicate with groundstation to tell it to instantly decrease tension (even when reeling out).
				
				visualization = new KiteVisualization("canvas_for_visualization", kite, wind);
				
				airfoilVisualization = new AirfoilCoefficientsVisualization("canvas_for_coefficients", kite.simpleWing1, kite.simpleWing2, "L,D");
				airfoilVisualization2 = new AirfoilCoefficientsVisualization("canvas_for_l_d", kite.simpleWing1, kite.simpleWing2, "L/D");
				
				animate();
			}
			
			function animate() {
				
				var timestep_in_ms = 1000/50; // 50Hz
				var timestep_in_s = 0.001*timestep_in_ms;
				
				if(running){
					
					// AUTOPILOT
					//autopilot.hover.Y.P = 1.5**y_p.value;
					
					wind.setSpeedAndDirection(wind_speed.value*0.5, wind_direction.value);
					wind.update();
					
					var controlData = autopilot.step(kite.getSensorData(), kite.positionR.length(), line_tension.value, timestep_in_s);
					document.getElementById("autopilot_logging").innerHTML = autopilot.loggingString;
					// UI and LINE TENSION
					line_tension.value = controlData.line_tension;
					smoothLineTension.step(timestep_in_s);
					smoothLineTension.setTargetValue(line_tension.value);
					
					let kite_line_length = kite.positionR.length();
					time += timestep_in_s;
					document.getElementById("time").innerHTML = "Time: " + time.toFixed(0) + " s (" + (time/3600).toFixed(3) + " h)";
					document.getElementById("rope_length").innerHTML = "Line length: " + kite_line_length.toFixed(0) + " m";
					document.getElementById("rope_angle_horizon").innerHTML = "Line angle to horizon: " + (180/Math.PI*Math.asin(projectToNormedVector(kite.positionR.clone().normalize(), new THREE.Vector3(1, 0, 0)).length())).toFixed(0) + " Grad";
					document.getElementById("flying_height").innerHTML = "Height: " + kite.positionR.x.toFixed(0) + " m";
					document.getElementById("speed").innerHTML = "Speed: " + kite.velocity.length().toFixed(0) + " m/s";
					let AoA = kite.simpleWing1.AoA_for_vis;
					let C_L = lift_coefficient(AoA, kite.simpleWing1);
					let C_D = drag_coefficient(AoA, 2*kite.simpleWing1.dimensions.y/kite.simpleWing1.dimensions.x, kite.simpleWing1);
					document.getElementById("glide_ratio").innerHTML = "L/D: " + (C_L/C_D).toFixed(1);
					if(old_kite_line_length != 0){
						let kite_line_length_difference = kite_line_length - old_kite_line_length;
						if(line_tension.value != 1){
							//groundstation.factor = autopilot.hover.Y.P;
							smoothLineTension.setTargetValue( groundstation.getLineTension(kite_line_length_difference/timestep_in_s) );
							line_tension.value = smoothLineTension.getValue();
						}
						let power = kite_line_length_difference*line_tension.value/timestep_in_s;
						energy += power * timestep_in_s;
						document.getElementById("power").innerHTML = "Power: " + power.toFixed(0) + " W (" + (energy/time).toFixed(0) + " W avg)";
						document.getElementById("energy").innerHTML = "Energy: " + energy.toFixed(0) + " Ws" + " (" + (energy/3600000).toFixed(6) + " kWh)";
						document.getElementById("electricity_cost").innerHTML = "Electricity Cost: " + (850/(energy/time)).toFixed(1) + " ct/kWh)";
						
					}
					old_kite_line_length = kite_line_length;
					
					
					// PHYSICS
					
					let timestep_fraction_in_s = timestep_in_s / timestep_multiplier;
					for (let i = 0; i < timestep_multiplier; i++){
					
						leftElevonServo.setTargetValue(controlData.left_elevon * Math.PI/180); leftElevonServo.step(timestep_fraction_in_s);
						rightElevonServo.setTargetValue(controlData.right_elevon * Math.PI/180); rightElevonServo.step(timestep_fraction_in_s);
						rudderServo.setTargetValue(controlData.rudder * Math.PI/180); rudderServo.step(timestep_fraction_in_s);
						leftBLDC.setTargetValue(controlData.left_prop); leftBLDC.step(timestep_fraction_in_s);
						rightBLDC.setTargetValue(controlData.right_prop); rightBLDC.step(timestep_fraction_in_s);
						
						kite.leftPropeller.setThrust(leftBLDC.getValue());
						kite.rightPropeller.setThrust(rightBLDC.getValue());
						if(!elevonControlOff){
							kite.leftElevon.rotation.y = leftElevonServo.getValue();
							kite.rightElevon.rotation.y = rightElevonServo.getValue();
						}
						kite.rudder.rotation.y = rudderServo.getValue();
						
						kite.update(wind, line_tension.value, timestep_fraction_in_s);
						kite.leftPropeller.update();
						kite.rightPropeller.update();
					}
				}
				document.getElementById("wind_speed_p").innerHTML = "Windspeed: " + (wind_speed.value*0.5).toFixed(1) + " m/s";
				document.getElementById("line_tension_p").innerHTML = "Line tension: " + line_tension.value + " N";
				
				visualization.update(timestep_in_s*running);
				
				render();
				
				setTimeout(function(){
				    requestAnimationFrame( animate )
				}, timestep_in_ms);
			}
			
			function render(){
				visualization.render();
			}
			
			function startPauseSimulation(){
				running = !running;
				if(running)
					document.getElementById("startPauseSimulation").style.color = "green";
				else
					document.getElementById("startPauseSimulation").style.color = "red";
			}
			
			function zoomIn(){
				visualization.camera.zoom *= 1.5;
				visualization.camera.updateProjectionMatrix();
			}
			
			function zoomOut(){
				visualization.camera.zoom *= 0.66;
				visualization.camera.updateProjectionMatrix();
			}
			
			function moveCamera(){
				
				if(camAttachedToKite){
					visualization.cameraAttachedToKite = false;
				}else{
					visualization.cameraAttachedToKite = true;
				}
				camAttachedToKite = !camAttachedToKite;
			}
			
			function land(){
				autopilot.mode = FINAL_LANDING_MODE;
			}
			
			function launch(){
				autopilot.mode = HOVER_MODE;
			}
			
			function elevonControlOff_func(){
				if(elevonControlOff){
					
					document.getElementById("elevonControlOff").style.color = "green";
					elevonControlOff = false;
				}else{
					
					document.getElementById("elevonControlOff").style.color = "red";
					elevonControlOff = true;
				}
			}

		</script>

	</body>
</html>
